# NoppFlow Code Reference

This file documents the current code structure and main symbols.

## Repository Layout

```text
noppflow/
├── cmd/cicd/              # Application entrypoint
├── internal/
│   ├── auth/              # Password hash/check helpers (bcrypt + legacy support)
│   ├── config/            # apps.yaml load/save + app model normalization
│   ├── pipeline/          # Clone/pull + dynamic step runner
│   ├── server/            # HTTP API + static serving + auth/session + k8s ephemeral jobs
│   └── store/             # Persistence (runs/users/groups/ssh keys)
├── web/                   # Static frontend (HTML/CSS/JS)
├── config/apps.yaml       # App definitions
└── README.md
```

## cmd/cicd

### `main.go`

- Parses flags (`-config`, `-db`, `-work`, `-static`, `-addr`)
- Resolves DB driver (`sqlite3` default, `mysql` via env)
- Loads apps from YAML
- Opens store and runs migrations
- Ensures bootstrap admin user (`ADMIN_USERNAME` / `ADMIN_PASSWORD`, default `admin/admin`)
- Starts HTTP server with `server.New(...).Handler()`

## internal/auth

### `auth.go`

- `HashPassword(password) (string, error)`
  Returns bcrypt hash.
- `CheckPassword(password, hash) bool`
  Validates plaintext against stored hash (bcrypt and legacy format).

## internal/config

### `config.go`

- `type App`
  App config model used by YAML and API JSON. Includes:
  - `id` (auto-generated by server on create)
  - `name`, `repo`, `branch`
  - `ssh_key_name`
  - dynamic `steps` (`name`, execution mode, `sleep_sec`)
  - k8s deploy fields (`deploy_mode`, `k8s_namespace`, `k8s_service_account`, `k8s_runner_image`, `deploy_manifest_path`, `helm_chart`, `helm_values_path`)
  - legacy `test_cmd/build_cmd/deploy_cmd` fields for backward compatibility
- `App.EffectiveSteps()`
  Returns normalized steps list (from `steps` or legacy fields).
- `NormalizeAppSteps(app)`
  Writes effective steps back to `app.Steps`.
- `LoadApps(path)`
  Reads `apps.yaml`.
- `SaveApps(path, apps)`
  Persists app list to YAML.

## internal/store

### `store.go`

Core entities:
- `Run`
- `User` (`IsAdmin` included)
- `Group`
- `SSHKey`

Core methods:
- Runs: `CreateRun`, `UpdateRunLog`, `UpdateRunStatus`, `GetRun`, `ListRuns`, `CountRuns`, `ListRunsByAppIDs`, `CountRunsByAppIDs`, `DeleteRunsByAppID`
- Users: `CreateUser`, `GetUser`, `GetUserByUsername`, `ListUsers`, `UpdateUserPassword`, `DeleteUser`, `EnsureAdminUser`
- Groups and mappings:
  - `CreateGroup`, `ListGroups`, `GetGroup`
  - `UserGroupIDs`, `SetUserGroups`, `GroupUserIDs`, `SetGroupUsers`
  - `AppGroupIDs`, `SetAppGroups`, `GroupAppIDs`, `SetGroupApps`
  - `AppIDsByUserGroupIDs`
- SSH keys:
  - `CreateSSHKey`, `ListSSHKeys`, `GetSSHKey`, `GetSSHKeyByName`, `DeleteSSHKey`
- Global env vars:
  - `CreateGlobalEnvVar`, `ListGlobalEnvVars`, `DeleteGlobalEnvVar`

Migrations create:
- `runs`
- `users` (`is_admin`)
- `groups`
- `user_groups`
- `app_groups`
- `ssh_keys`
- `global_env_vars`

## internal/pipeline

### `pipeline.go`

- `Runner.Run(app, opts, onLogUpdate)` executes:
  1. clone/pull
  2. app dynamic steps in order
     - `cmd` -> parsed command
     - `file` -> `sh <file>`
     - `script` -> `sh -c <script>`
     - `k8s_deploy` -> `kubectl`/`helm` based on app deploy config
- Streams log updates through callback.
- Supports `RunOptions.GitSSHCommand` for clone/pull auth (SSH key per app).

## internal/server

### `server.go`

Responsibilities:
- Session auth via cookie
- Role-based authorization
- Group-based app visibility/access
- App CRUD + run trigger
- Ephemeral Kubernetes Job orchestration for apps with `k8s_deploy` steps
- SSH key CRUD + app SSH-key validation
- Global env vars CRUD (admin only), injected into step execution
- Users/groups/admin operations
- Static file serving

Public HTTP routes:
- Health: `GET /health`
- Auth:
  - `POST /api/auth/login`
  - `POST /api/auth/logout`
  - `GET /api/auth/me`
  - `PUT /api/auth/password`
  - `GET /api/auth/profile`
- Apps:
  - `GET /api/apps`
  - `POST /api/apps`
  - `GET /api/apps/{appID}`
  - `PUT /api/apps/{appID}`
  - `DELETE /api/apps/{appID}`
  - `GET /api/apps/{appID}/groups`
  - `PUT /api/apps/{appID}/groups`
  - `POST /api/apps/{appID}/run`
- SSH keys (admin):
  - `GET /api/ssh-keys`
  - `POST /api/ssh-keys`
  - `DELETE /api/ssh-keys/{keyID}`
- Global env vars (admin):
  - `GET /api/env-vars`
  - `POST /api/env-vars`
  - `PUT /api/env-vars/{envVarID}`
  - `DELETE /api/env-vars/{envVarID}`
- Runs:
  - `GET /api/runs`
  - `GET /api/runs/{id}`
- Users (admin):
  - `GET /api/users`
  - `POST /api/users`
  - `PUT /api/users/{userID}/groups`
  - `PUT /api/users/{userID}/password`
  - `DELETE /api/users/{userID}`
- Groups (admin):
  - `GET /api/groups`
  - `POST /api/groups`
  - `GET /api/groups/{groupID}`
  - `PUT /api/groups/{groupID}/users`
  - `PUT /api/groups/{groupID}/apps`

Authorization model:
- Admin: full access
- Non-admin:
  - sees only allowed apps (by group bindings)
  - can run allowed apps
  - can edit allowed apps
  - sees only runs for allowed apps

Deletion behavior:
- Deleting an app also deletes all runs for that app.
- Deleting an SSH key is blocked while any app references it.

### `k8s_job_runner.go`

- Creates temporary Secret with app SSH private key.
- Creates ephemeral Job per run in target app namespace.
- Polls pod logs and Job completion.
- Streams logs into run record and maps completion to run success/failed.

## web

### Main pages

- `/login.html`
- `/` (runs)
- `/apps.html`
- `/app-form.html`
- `/profile.html`
- `/access.html` (admin)
- `/group.html?group_id=` (admin)
- `/docs.html`

### `web/js/app.js`

Contains:
- API client helpers
- auth/bootstrap checks
- runs/apps rendering and actions
- app step editor and SSH key selector in app form
- admin access management flows (users/groups/app permissions/SSH keys)
- group detail page editor
- profile rendering and self password change

### `web/css/style.css`

Shared theme and component styles used by all pages.
